# 言語プラグインリファクタリング計画

## 概要

本ドキュメントでは、言語プラグインのコード重複を削減し、設計を統一するためのリファクタリング計画を定義します。リスクを最小限に抑えるため、段階的な移行戦略を採用します。

## フェーズ 1: 基盤整備

**目標**: 基底クラス `ProgrammingLanguageExtractor` を拡張し、新アーキテクチャに対応させる。

1.  **ゴールデンマスターの作成**: 現在の解析ロジックでの出力を保存し、リファクタリング後の検証用とする。
2.  **基底クラスの拡張**: `ProgrammingLanguageExtractor` に以下のメソッドを追加（既存のメソッドは維持）。
    *   `_extract_common_metadata`: ノードから基本情報を一括抽出
    *   `_get_default_decision_keywords`: デフォルトの複雑度キーワード定義
    *   `extract_functions_template`: テンプレートメソッド版（名前は一時的、既存実装と共存させるため）
    *   `extract_classes_template`: テンプレートメソッド版

## フェーズ 2: パイロット移行 (Python)

**目標**: 比較的構造が標準的な Python プラグインを新アーキテクチャに移行し、設計を検証する。

1.  **ハンドラメソッドの実装**: `_get_function_handlers` などを実装。
2.  **テンプレートメソッドへの切り替え**: `extract_functions` を、基底クラスのテンプレートメソッドを使用するように変更。
3.  **検証**: テストとゴールデンマスター比較を実行。

## フェーズ 3: 他言語への展開

**目標**: 残りの主要言語プラグインを順次移行する。

1.  **JavaScript/TypeScript**:
    *   JSとTSは構造が似ているため、並行して移行可能。
    *   `_detect_file_characteristics` (React/Vue/Angular検出) のフック実装が重要。
2.  **Java**:
    *   アノテーション処理やバッチ処理 (`_process_field_batch`) などの独自ロジックをどう統合するか慎重に検討する。
3.  **SQL**:
    *   構造が最も異なるため、最後に対応。無理にテンプレートに当てはめず、必要に応じてオーバーライドを維持する。

## フェーズ 4: クリーンアップ

**目標**: リファクタリングによって不要になったコードを削除する。

1.  **非推奨コードの削除**: 各プラグイン内の重複ロジック（複雑度計算の個別実装など）を削除。
2.  **メソッド名の正規化**: 一時的なメソッド名（`extract_functions_template` など）を正式名に統合。

## リスクと軽減策

| リスク | 軽減策 |
| :--- | :--- |
| **機能退行 (Regression)** | ゴールデンマスターテストによる厳密な入出力比較を行う。 |
| **パフォーマンス低下** | 共通化によるオーバーヘッドが発生しないか、プロファイリングを行う。特に大規模ファイルのAST走査に注意。 |
| **SQLなどの特殊ケース** | テンプレートメソッドパターンを強制せず、必要に応じてオーバーライドを許可する柔軟な設計にする。 |

## テスト戦略詳細

### 1. ゴールデンマスターテスト (Regression Testing)

リファクタリング着手前に、既存の `examples/` 内の全ファイルに対して解析を実行し、そのJSON出力を「正解データ」として保存します。

```bash
# ゴールデンマスター生成（リファクタリング前）
python scripts/generate_golden_masters.py

# 検証（リファクタリング後）
python scripts/verify_golden_masters.py
```

### 2. ユニットテスト

既存の `tests/` ディレクトリ内のユニットテストを全てパスすることを必須とします。基底クラスの新しいメソッドに対しても、新たなユニットテストを追加します。
