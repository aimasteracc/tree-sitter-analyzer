# 要件ドキュメント

## はじめに

本機能は、Tree-sitter Analyzer に TOON（Token-Oriented Object Notation）フォーマットを統合し、LLMとの対話時のトークン消費を大幅に削減することを目的とします。TOONは、JSONに比べて50-70%のトークン削減を実現しながら、YAML風の構造で人間にも読みやすい形式を維持します。

### 背景と問題点

| 問題 | 説明 |
|------|------|
| **大量のJSON出力** | 分析結果が冗長なJSON形式で出力され、トークン消費が大きい |
| **MCP Tool Responses** | AI assistantへの応答が標準JSONで、構造化データが非効率 |
| **バッチ分析結果** | 複数ファイルの分析結果が冗長 |
| **テーブル形式の限界** | CSV/JSONテーブル出力が最適化されていない |

### TOON導入の利点

- **トークン削減**: 最大60-70%のトークン削減
- **可読性維持**: YAML風の構造で人間にも読みやすい
- **構造化データ最適化**: 配列データをCSV風に圧縮
- **LLM最適化**: AIモデルが自然に解析可能な形式

### 依存関係決策

| 項目 | 決定 |
|------|------|
| **実装方式** | 軽量カスタム実装（外部依存なし） |
| **理由** | PyPI `toon-format` パッケージは名前空間占有のみで未実装 |
| **利点** | プロジェクト固有の最適化、完全な制御権、ゼロ依存オーバーヘッド |

## 用語集

| 用語 | 説明 |
|------|------|
| **TOON** | Token-Oriented Object Notation - トークン最適化されたデータ記法 |
| **ToonEncoder** | 低レベルのTOONエンコーディングプリミティブを提供するクラス |
| **ToonFormatter** | 高レベルのフォーマッター、統一インターフェース `format()` を提供 |
| **Formatter Protocol** | すべてのフォーマッターが実装する `format(data: Any) -> str` インターフェース |
| **Array Table** | 同型配列をCSV風にコンパクトに表現する形式 |
| **FileOutputManager** | MCP ツール用のファイル出力管理クラス |

## 要件

### 要件1: TOON Encoder 基本実装

**ユーザーストーリー**: 開発者として、任意のPythonデータをTOON形式にエンコードできるようにしたい。

#### 受け入れ基準

1. スカラー値（string, number, boolean, null）を正しくエンコードすること
2. ネストされた辞書を適切なインデントで処理すること
3. 同型配列をスキーマ付きテーブル形式でエンコードすること
4. 特殊文字を含む文字列を適切にエスケープすること
5. カンマ区切りとタブ区切りの両方をサポートすること
6. 区切り文字変更がスキーマヘッダーと値行の両方に一貫して適用されること

### 要件2: TOON Formatter 実装

**ユーザーストーリー**: 開発者として、AnalysisResultやMCPレスポンスをTOON形式でフォーマットできるようにしたい。

#### 受け入れ基準

1. 統一インターフェース `format(data: Any) -> str` を実装すること
2. AnalysisResultを適切なTOON形式に変換すること
3. MCPレスポンス構造を検出し最適化すること
4. 汎用辞書も処理可能であること
5. BaseFormatterプロトコルに準拠すること

### 要件3: OutputManager 統合

**ユーザーストーリー**: ユーザーとして、CLIで `--format toon` を指定してTOON形式で出力を取得したい。

#### 受け入れ基準

1. OutputManagerのformatter registryにToonFormatterを登録すること
2. `SUPPORTED_FORMATS` に "toon" を追加すること
3. `data()` メソッドで統一的にformatter.format()を呼び出すこと
4. JSON形式をデフォルトとして維持し、TOON形式はオプトインとすること

### 要件4: MCP ツール統合

**ユーザーストーリー**: AI assistantとして、MCP toolsでTOON形式の出力を取得し、トークン消費を削減したい。

#### 対象MCPツール

| ツール名 | ファイルパス | 説明 |
|---------|-------------|------|
| analyze_scale_tool | `mcp/tools/analyze_scale_tool.py` | スケール分析 |
| universal_analyze_tool | `mcp/tools/universal_analyze_tool.py` | 汎用分析 |
| list_files_tool | `mcp/tools/list_files_tool.py` | ファイルリスト |
| table_format_tool | `mcp/tools/table_format_tool.py` | テーブル形式 |

#### 受け入れ基準

1. 各MCPツールに `output_format` パラメータを追加すること
2. `"toon"` オプションを指定した場合、TOON形式で出力すること
3. デフォルトはJSON形式を維持すること
4. FileOutputManager (`mcp/utils/file_output_manager.py`) にTOON形式検出ロジックを追加すること
5. ".toon" 拡張子マッピングを追加すること

### 要件5: CLI 統合

**ユーザーストーリー**: コマンドラインユーザーとして、分析結果をTOON形式で取得したい。

#### 受け入れ基準

1. `--format toon` オプションをサポートすること
2. `--toon-use-tabs` オプションでタブ区切りを有効化できること
3. バッチ分析でもTOON形式が機能すること
4. ファイル出力 (`-o`) でもTOON形式が機能すること

### 要件6: テストとドキュメント

**ユーザーストーリー**: プロジェクトメンテナーとして、TOON機能の品質を保証したい。

#### 受け入れ基準

1. 新規コードのテストカバレッジが90%以上であること
2. ユニットテスト、統合テスト、ベンチマークテストを含むこと
3. ユーザードキュメントを作成すること
4. 使用例とデモスクリプトを提供すること
5. トークン削減率50%以上を達成すること

#### 必須テストケース

| カテゴリ | テストケース |
|---------|-------------|
| スカラーエンコード | null, boolean, number, string |
| 文字列エスケープ | 特殊文字（\n, \t, \r, \\, \"） |
| 辞書エンコード | シンプル、ネスト、空辞書 |
| 配列エンコード | プリミティブ配列、同型辞書配列 |
| Array Table | スキーマ推論、明示的スキーマ |
| Formatter Protocol | format()メソッド準拠 |
| OutputManager統合 | レジストリ初期化、フォーマット選択 |
| エラーハンドリング | 循環参照、エンコード失敗 |
| パフォーマンス | 大規模データセット処理 |

### 要件7: エラーハンドリング

**ユーザーストーリー**: 開発者として、TOON エンコードが失敗した場合でも安全にフォールバックしたい。

#### 受け入れ基準

1. 循環参照を検出し、適切なエラーを報告すること
2. エンコード失敗時にJSONフォールバックを提供すること
3. エラーログを記録すること
4. ユーザーへのエラーメッセージが明確であること

## 成功指標

### 定量的指標

| 指標 | 目標 |
|------|------|
| トークン削減率 | JSON比で50-60%削減 |
| エンコードオーバーヘッド | JSON比5%未満 |
| メモリオーバーヘッド | JSON比10%未満 |
| テストカバレッジ | 新規コード90%以上 |

### 定性的指標

| 指標 | 目標 |
|------|------|
| 可読性 | 人間が読んでも理解しやすい |
| 互換性 | 既存のJSON出力と並行利用可能 |
| 拡張性 | 新しいデータ型に対応しやすい |

### トークン削減率検証方法

| 項目 | 定義 |
|------|------|
| **トークナイザー** | tiktoken (cl100k_base) または同等の手段 |
| **ベンチマークデータ** | 実プロジェクトの分析結果 5ファイル以上 |
| **計算式** | `(1 - TOON_tokens / JSON_tokens) × 100%` |
| **検証対象** | AnalysisResult, MCPレスポンス, バッチ分析結果 |

## 後方互換性

### 原則

| 原則 | 説明 |
|------|------|
| **デフォルト動作** | JSON形式を引き続きデフォルトとして維持 |
| **オプトイン方式** | TOON形式は明示的な指定でのみ有効化 |
| **並行動作** | JSON/YAML/TOON形式が同時に利用可能 |
| **非推奨化なし** | JSON形式は非推奨化の予定なし |

### 実装要件

1. **CLI**: `--format` オプション未指定時は `json` を使用
2. **MCP Tools**: `output_format` パラメータ未指定時は `json` を使用
3. **Python API**: `format_type="json"` がデフォルト
4. **テスト**: 既存のすべてのテストがパラメータ変更なしでパス

## リスクと対策

### リスク1: カスタム実装の保守負担

| 項目 | 内容 |
|------|------|
| **リスク** | 自社実装のメンテナンスコストが増加する可能性 |
| **対策** | シンプルな実装（合計 ~500 LOC）、明確な責任分離、包括的なテスト |
| **モニタリング** | コードカバレッジ80%以上を維持 |

### リスク2: LLMの解析精度

| 項目 | 内容 |
|------|------|
| **リスク** | LLMがTOON形式を正しく解析できない可能性 |
| **対策** | YAML風シンタックス採用、フォールバック機構、エラーロギング |
| **テスト** | 複数のLLMプロバイダーでテスト |

### リスク3: パフォーマンス問題

| 項目 | 内容 |
|------|------|
| **リスク** | エンコード/デコードのオーバーヘッドが大きい可能性 |
| **対策** | ストリーミングエンコーディング、スキーマキャッシング |
| **目標** | オーバーヘッド5%未満 |

### リスク4: エンコード失敗

| 項目 | 内容 |
|------|------|
| **リスク** | 特殊なデータ構造でエンコードが失敗する可能性 |
| **対策** | 循環参照検出、JSONフォールバック、詳細なエラーログ |
| **検証** | エッジケーステスト（循環参照、バイナリデータなど） |

## 現在の実装状況

### 完了項目 ✅

| コンポーネント | ファイル | 行数 (空行除く) |
|---------------|---------|-----------------|
| ToonEncoder | `formatters/toon_encoder.py` | ~239 LOC |
| ToonFormatter | `formatters/toon_formatter.py` | ~249 LOC |
| BaseFormatter | `formatters/base_formatter.py` | ~233 LOC |
| OutputManager統合 | `output_manager.py` | 更新済み |
| テスト | `test_toon_formatter_integration.py` | 37 tests |

### 完了項目 ✅ (Phase 2)

| コンポーネント | ファイル | 説明 |
|---------------|---------|------|
| MCP Tools統合 | `mcp/tools/*.py` (8ツール) | output_format パラメータ追加 |
| Format Helper | `mcp/utils/format_helper.py` | TOON/JSONフォーマット変換ユーティリティ |
| FileOutputManager TOON対応 | `mcp/utils/file_output_manager.py` | .toon拡張子、形式検出 |
| MCP統合テスト | `tests/mcp/test_toon_mcp_integration.py` | 24 tests |

### 未完了項目 ❌

| コンポーネント | 状態 | 対象ファイル |
|---------------|------|-------------|
| CLI `--format toon` オプション | 未着手 | `cli/main.py`, `cli/commands/*.py` |
| パフォーマンス最適化 | 未着手 | - |
| ユーザードキュメント | 未着手 | `docs/toon-format-guide.md` |
| エラーハンドリング強化 | 未着手 | `formatters/toon_encoder.py` |
