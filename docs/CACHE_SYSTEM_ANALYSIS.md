# キャッシュシステム設計分析と改善提案

## 1. はじめに

本ドキュメントは、`tree-sitter-analyzer` プロジェクトに存在する2つのキャッシュシステム（`UnifiedAnalysisEngine`キャッシュと`SearchContentTool`キャッシュ）の設計を分析し、その妥当性を評価するとともに、今後の改善案を提案するものである。

## 2. キャッシュシステムの現状分析

### 2.1. UnifiedAnalysisEngine キャッシュ

- **目的**: `tree-sitter`によるコード解析結果（AST、シンボルテーブル等）をキャッシュし、同一ファイル・同一オプションでの再解析を防ぎ、パフォーマンスを向上させる。
- **実装**: `tree_sitter_analyzer/core/cache_service.py` にて実装。L1 (LRU), L2 (TTL), L3 (LRU) の3層階層キャッシュを採用し、高速なアクセスと中長期的なデータ保持を両立させている。
- **役割**: **解析結果そのもの**をキャッシュする、システムのコア機能。

### 2.2. SearchContentTool キャッシュ

- **目的**: `ripgrep`を利用したファイル内容検索（`search_content` ツール）の結果をキャッシュし、同一検索クエリの再実行を高速化する。
- **実装**: `tree_sitter_analyzer/mcp/utils/search_cache.py` にて実装。LRU (Least Recently Used) と TTL (Time To Live) を組み合わせたキャッシュ方式。
- **役割**: **特定のツールの実行結果**をキャッシュする、補助的なキャッシュ。

## 3. 設計の妥当性評価

2つのキャッシュシステムが共存している現状は、以下の理由から設計として**妥当**であると評価する。

1.  **役割と関心の分離**:
    - `UnifiedAnalysisEngine`キャッシュは、多くのツールから利用される汎用的な「コード解析データ」を扱う。
    - `SearchContentTool`キャッシュは、「特定の検索ツールの実行結果」という、より特化したデータを扱う。
    - この役割分担により、それぞれのキャッシュ戦略（階層型 vs. LRU+TTL）を最適化できている。

2.  **ライフサイクルの違い**:
    - コード解析結果は、ソースファイルが変更されない限り永続的に有効であるべき。
    - 検索結果は、より短期的なコンテキストで利用されることが多い。
    - 異なるキャッシュ戦略は、このライフサイクルの違いを適切に反映している。

3.  **アーキテクチャの整合性**:
    - コアな解析エンジンと、それを利用するMCPツール群はアーキテクチャ上分離されている。それぞれのレイヤーでキャッシュを持つことは、責務が明確になり、疎結合な設計を維持する上で有効である。

## 4. 改善提案

現状の設計は妥当であるが、テストの信頼性向上と保守性の観点から、以下の改善を提案する。

### 4.1. キャッシュ管理の一元化と拡張性の向上

`compatibility_test/utils/cache_manager.py` を拡張し、将来的にキャッシュシステムが追加された場合でも容易に対応できるよう、より汎用的なキャッシュ管理機構を導入する。

- **提案**: キャッシュクリアのロジックをプラグイン化または登録制にし、`CacheManager` が動的にクリア対象を検出できるようにする。

### 4.2. テスト実行時のキャッシュ制御機能

互換性テスト実行時に、キャッシュの有効/無効を外部から容易に制御できる仕組みを導入する。

- **提案**: `run_compatibility_test.py` に `--no-cache` や `--clear-cache` のようなコマンドライン引数を追加し、テスト実行ごとにキャッシュポリシーを選択できるようにする。これにより、キャッシュがテスト結果に与える影響を明確に切り分けられる。

### 4.3. ドキュメントの拡充

2つのキャッシュシステムの存在理由、それぞれの役割、そしてテストにおけるキャッシュ管理の重要性について、開発者向けドキュメントに明記する。

- **提案**: `docs/developer_guide.md` や `compatibility_test/README.md` に、キャッシュシステムの概要と、テスト実行時の注意点（キャッシュのクリア方法など）を追記する。

## 5. 結論

2つのキャッシュシステムは、それぞれの目的において合理的に設計されており、共存は妥当である。統合の必要性は低く、むしろ現状の分離設計を維持しつつ、本ドキュメントで提案した管理・制御・ドキュメント化の改善を進めることが、プロジェクト全体の品質向上に寄与すると結論付ける。