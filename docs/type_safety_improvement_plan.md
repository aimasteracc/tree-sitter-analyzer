# 型安全性向上計画書

## 1. はじめに

この文書は、`tree-sitter-analyzer`プロジェクトに残存する100個のmypyエラーを解消し、完全な型安全性を達成するための改善計画を定めるものです。

## 2. 現状分析

mypyエラー修正作業により、エラー総数は317個から100個まで大幅に削減されました。しかし、依然として以下の課題が残存しています。

- **エラーの集中**: 残存エラーの**52%**（52個）が`tree_sitter_analyzer/languages/markdown_plugin.py`に集中しています。
- **複雑な型**: 動的な型生成、ジェネリクス、および一部のライブラリとの連携部分で、型解決が困難な箇所が残っています。
- **高重要度エラー**: 「属性・名前未定義（`attr-defined`, `name-defined`）」といった実行時エラーに直結する可能性のあるエラーが少数ながら存在します。

## 3. 改善ロードマップ

残存エラーを効率的かつ効果的に解消するため、以下の3フェーズで改善作業を進めます。

### フェーズ1: `markdown_plugin.py`の集中リファクタリング（目標: -50個）

- **期間**: 1週間
- **担当**: プラグイン開発チーム
- **内容**:
    1. `MarkdownElement`の型階層を見直し、よりシンプルで堅牢な構造に再設計します。
    2. 複雑な継承関係を整理し、`Union`型やプロトコル（`Protocol`）を活用して柔軟性を保ちつつ型安全性を高めます。
    3. 各抽出メソッド（`extract_headings`, `extract_links`など）の戻り値の型を厳密に定義し、型の一貫性を確保します。
    4. 既存のテストを拡張し、リファクタリング後の型安全性を保証するテストケースを追加します。

### フェーズ2: 高・中重要度エラーの解消（目標: -30個）

- **期間**: 1週間
- **担当**: コアエンジン開発チーム
- **内容**:
    1. `attr-defined`および`name-defined`エラーを最優先で修正し、潜在的な実行時エラーのリスクをゼロにします。
    2. `return-value`（戻り値の型不整合）および`assignment/call-arg`（代入・呼び出し時の型不整合）エラーを修正し、データフローの信頼性を向上させます。
    3. `Any`型が意図せず使用されている箇所を特定し、より具体的な型に置き換えます。

### フェーズ3: 残存エラーのクリーンアップと最終検証（目標: -20個）

- **期間**: 3日間
- **担当**: 品質保証チーム
- **内容**:
    1. `var-annotated`（型注釈不足）や`unreachable`（到達不能コード）などの低重要度エラーを解消し、コードの可読性と品質を最終調整します。
    2. プロジェクト全体で`mypy --strict`モードでのチェックを実行し、より厳格な基準での型安全性を検証します。
    3. `pyproject.toml`のmypy設定を見直し、将来的により厳格なルールを段階的に導入する計画を立てます。

## 4. 期待される成果

この計画を完遂することにより、以下の成果が期待されます。

- **mypyエラーゼロ**: プロジェクトの型安全性が100%達成されます。
- **保守性の向上**: 型定義が明確になることで、将来の機能追加やリファクタリングが容易になります。
- **バグの未然防止**: 静的型チェックによって、多くの潜在的なバグが開発段階で検出されるようになります。
- **開発者体験の向上**: IDEによる補完やエラー検出がより正確になり、開発効率が向上します。

## 5. 結論

本計画は、`tree-sitter-analyzer`をより堅牢で信頼性の高いツールへと進化させるための重要なステップです。計画的なアプローチにより、完全な型安全性を達成し、プロジェクトの長期的な成功に貢献します。