# 実装タスク

## 1. コア実装

### 1.1 EncodingManager統合
- [ ] `search_content_tool.py`にEncodingManagerのインポート追加
- [ ] 自動エンコーディング検出関数`_detect_file_encoding()`の実装
- [ ] ファイルサンプリング機能の実装（先頭1KB読み込み）
- [ ] 検出結果のキャッシュ機能統合

### 1.2 search_content_tool.pyの修正
- [ ] `execute()`メソッドに自動検出ロジック追加
- [ ] encodingパラメータ未指定時の検出処理実装
- [ ] 明示的encodingパラメータの優先処理確認
- [ ] エラーハンドリングとフォールバック機能実装

### 1.3 fd_rg_utils.pyの拡張
- [ ] `build_rg_command()`の自動検出エンコーディング対応
- [ ] エンコーディング検出失敗時のデフォルト処理
- [ ] ログ出力機能の追加

## 2. テスト実装

### 2.1 単体テスト作成
- [ ] `test_search_content_encoding_detection.py`作成
- [ ] Shift_JIS自動検出テスト実装
- [ ] UTF-8デフォルト処理テスト実装
- [ ] エンコーディング検出失敗テスト実装
- [ ] 明示的encodingパラメータ優先テスト実装

### 2.2 統合テスト作成
- [ ] `test_encoding_consistency.py`作成
- [ ] extract_code_sectionとsearch_contentの一貫性テスト
- [ ] 複数エンコーディングファイル混在テスト
- [ ] パフォーマンステスト（検出時間100ms以下）

### 2.3 回帰テスト確認
- [ ] 既存のsearch_contentテスト全実行
- [ ] 後方互換性確認テスト
- [ ] エラーケーステスト

## 3. 品質保証

### 3.1 コード品質チェック
- [ ] `mypy --strict`でのタイプチェック
- [ ] `ruff check`でのリンティング
- [ ] `black`でのフォーマット確認
- [ ] docstring追加（Google形式）

### 3.2 テストカバレッジ
- [ ] 新機能のテストカバレッジ90%以上確保
- [ ] 既存機能のカバレッジ維持確認
- [ ] エッジケースのテスト追加

## 4. ドキュメント

### 4.1 コード内ドキュメント
- [ ] 自動検出機能のdocstring追加
- [ ] 型ヒントの完全性確認
- [ ] インラインコメントの追加

### 4.2 ログ機能実装
- [ ] 検出結果のDEBUGログ実装
- [ ] パフォーマンス情報のログ実装
- [ ] エラー時の詳細ログ実装

## 5. 統合テスト

### 5.1 実際のファイルでのテスト
- [ ] `examples/encoding.txt`での動作確認
- [ ] 複数エンコーディングファイルでのテスト
- [ ] 大きなファイルでのパフォーマンステスト

### 5.2 MCPツール統合テスト
- [ ] MCP経由での動作確認
- [ ] エラーレスポンスの確認
- [ ] キャッシュ機能の動作確認

## 6. パフォーマンス検証

### 6.1 パフォーマンス測定
- [ ] エンコーディング検出時間の測定
- [ ] メモリ使用量の確認
- [ ] 大量ファイル処理時の性能確認

### 6.2 最適化
- [ ] 不要な処理の削除
- [ ] キャッシュ効率の改善
- [ ] エラーハンドリングの最適化

## 7. 最終検証

### 7.1 機能確認
- [ ] 問題となった「これは」検索の動作確認
- [ ] 各エンコーディングでの検索成功確認
- [ ] 既存機能の非破壊確認

### 7.2 品質ゲート
- [ ] 全テストパス確認
- [ ] コード品質チェック全クリア
- [ ] パフォーマンス要件達成確認
- [ ] セキュリティ要件確認

## 依存関係

- **並行作業**: テスト作成と実装は並行実行可能
- **ブロッキング依存関係**:
  - 1.1完了後に1.2開始
  - 1.2完了後に2.1開始
  - 全実装完了後に5.1開始

## 成功基準

- [ ] `examples/encoding.txt`で「これは」が検索できる
- [ ] 既存のsearch_content機能が全て正常動作
- [ ] 新機能のテストカバレッジ90%以上
- [ ] パフォーマンス劣化なし（検出時間100ms以下）
- [ ] mypy, ruff, blackの品質チェック全クリア
