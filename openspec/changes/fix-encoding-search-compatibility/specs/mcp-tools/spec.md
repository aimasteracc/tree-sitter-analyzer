## 追加要件

### 要件: 自動エンコーディング検出機能

search_contentツールは、ユーザーがencodingパラメータを指定しない場合、自動的にファイルのエンコーディングを検出し、適切なエンコーディングでripgrepを実行しなければならない（MUST）。

#### シナリオ: Shift_JISファイルの自動検出と検索

**前提条件** Shift_JISエンコーディングで保存された日本語テキストファイルが存在する場合
**実行時** encodingパラメータを指定せずに日本語文字列で検索する
**期待結果** 自動的にShift_JISエンコーディングが検出される
**かつ** ripgrepに`--encoding shift-jis`パラメータが適用される
**かつ** 日本語文字列が正常に検索される

#### シナリオ: UTF-8ファイルのデフォルト処理

**前提条件** UTF-8エンコーディングで保存されたファイルが存在する場合
**実行時** encodingパラメータを指定せずに検索する
**期待結果** UTF-8として処理される
**かつ** 検索が正常に実行される

#### シナリオ: エンコーディング検出失敗時のフォールバック

**前提条件** エンコーディング検出が失敗した場合
**実行時** 自動検出処理が実行される
**期待結果** UTF-8をデフォルトエンコーディングとして使用する
**かつ** 検索処理が継続される

### 要件: EncodingManager統合

search_contentツールは、既存のEncodingManagerクラスを活用してエンコーディング検出を行い、他のツールとの一貫性を保たなければならない（MUST）。

#### シナリオ: EncodingManagerによる検出

**前提条件** 複数のエンコーディングが混在するファイル群が存在する場合
**実行時** search_contentツールで検索を実行する
**期待結果** EncodingManager.detect_encoding()が使用される
**かつ** 検出結果がripgrepのencodingパラメータに適用される

#### シナリオ: extract_code_sectionとの一貫性

**前提条件** 同一ファイルに対してextract_code_sectionとsearch_contentを実行する場合
**実行時** 両方のツールでエンコーディング検出が実行される
**期待結果** 同じEncodingManagerが使用される
**かつ** 一貫したエンコーディング検出結果が得られる

### 要件: 後方互換性保証

search_contentツールの自動エンコーディング検出機能は、既存のencodingパラメータの動作を変更せず、完全な後方互換性を維持しなければならない（MUST）。

#### シナリオ: 明示的encodingパラメータの優先

**前提条件** encodingパラメータが明示的に指定された場合
**実行時** 自動検出機能が有効な状態で検索を実行する
**期待結果** 指定されたencodingパラメータが優先される
**かつ** 自動検出処理はスキップされる
**かつ** 従来と同じ動作が保証される

#### シナリオ: 既存APIの非破壊性

**前提条件** 既存のsearch_content使用コードが存在する場合
**実行時** 自動エンコーディング検出機能が追加された後に実行する
**期待結果** 既存コードが変更なしで動作する
**かつ** 同一の結果が返される

### 要件: パフォーマンス最適化

自動エンコーディング検出は、検索パフォーマンスに最小限の影響しか与えず、効率的に実行されなければならない（MUST）。

#### シナリオ: ファイルサンプリングによる効率的検出

**前提条件** 大きなファイルに対して検索を実行する場合
**実行時** 自動エンコーディング検出が実行される
**期待結果** ファイルの先頭部分のみをサンプリングして検出する
**かつ** 全ファイル読み込みは行わない
**かつ** 検出時間が100ms以下に収まる

#### シナリオ: キャッシュ機能の活用

**前提条件** 同一ファイルに対して複数回検索を実行する場合
**実行時** 自動エンコーディング検出が実行される
**期待結果** 検出結果がキャッシュされる
**かつ** 2回目以降はキャッシュから取得される
**かつ** 検出処理がスキップされる

### 要件: エラーハンドリング強化

自動エンコーディング検出の失敗は適切にハンドリングされ、検索処理の継続性を保たなければならない（MUST）。

#### シナリオ: 検出失敗時の適切なフォールバック

**前提条件** エンコーディング検出が失敗した場合
**実行時** search_contentツールが実行される
**期待結果** UTF-8をデフォルトとして検索を継続する
**かつ** 警告ログが出力される
**かつ** エラーで処理が中断されない

#### シナリオ: 部分的検出失敗の処理

**前提条件** 複数ファイルの検索で一部のファイルの検出が失敗した場合
**実行時** 検索処理が実行される
**期待結果** 検出成功ファイルは適切なエンコーディングで処理される
**かつ** 検出失敗ファイルはデフォルトエンコーディングで処理される
**かつ** 全体の検索処理が継続される

### 要件: ログとデバッグ支援

自動エンコーディング検出の動作は適切にログ出力され、デバッグとトラブルシューティングを支援しなければならない（MUST）。

#### シナリオ: 検出結果のログ出力

**前提条件** 自動エンコーディング検出が実行された場合
**実行時** 検出が完了する
**期待結果** 検出されたエンコーディングがDEBUGレベルでログ出力される
**かつ** 検出にかかった時間が記録される
**かつ** 使用されたサンプルサイズが記録される

#### シナリオ: ripgrepコマンドの可視化

**前提条件** 自動検出されたエンコーディングがripgrepに適用された場合
**実行時** ripgrepコマンドが構築される
**期待結果** 適用されたencodingパラメータがログ出力される
**かつ** コマンド全体がDEBUGレベルで記録される
