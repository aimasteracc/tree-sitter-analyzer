# 提案: エンコーディングサポートとファイル処理の強化

## 概要
tree-sitter-analyzerシステム全体で多様なファイルエンコーディング（Shift_JIS、CP932、Latin-1など）の処理と、統一されたファイルパス検証・解決・セキュリティ機能を実装する包括的な改善。

## 問題の定義
現在のシステムには以下の制限がある：

### 1. エンコーディング関連の問題
- **UTF-8のハードコーディング** - 言語プラグインやMCPツールで異なるエンコーディングのファイルを処理する際にUnicodeDecodeErrorが発生
- **ripgrepエンコーディングパラメータの非互換性** - "Shift_JIS"などのエンコーディング名がripgrepで認識されず、"shift-jis"への正規化が必要
- **一貫性のないエンコーディング検出** - 異なるコンポーネント間でパース失敗を引き起こす

### 2. ファイルパス処理の問題
- **分散したファイル検証ロジック** - 各コンポーネントで独自のファイル存在チェックとパス解決
- **セキュリティ検証の不統一** - MCPツール間でセキュリティ検証の実装が異なる
- **パス解決の不一致** - 相対パス・絶対パスの処理が統一されていない
- **エラーハンドリングの不一致** - ファイル読み込みエラーの処理方法が統一されていない

### 3. 検索機能の問題
- **ファイルモード処理の非効率性** - search_contentツールでファイル指定時のパス解決が不適切
- **ripgrepコマンド構築の不統一** - エンコーディング正規化とパス処理の分離

### 4. テストカバレッジの問題
- **包括的テストの不足** - 様々なエンコーディングとファイルパスシナリオのテストが不十分

## 提案する解決策
以下を含む統一ファイル処理・エンコーディングサポートシステムを実装：

### 1. エンコーディング統一システム
- **ripgrep互換性のためのエンコーディング正規化** - エンコーディング名をripgrep互換形式に正規化
- **システム全体での安全なエンコーディング検出** - ハードコーディングされたUTF-8を自動エンコーディング検出に置換
- **パフォーマンス最適化キャッシュ** - エンコーディング検出結果のキャッシュ
- **デバッグログ強化** - エンコーディング正規化プロセスの可視化

### 2. 統一ファイル処理システム
- **統一ファイル検証API** - `validate_file()`の標準化と全コンポーネントでの使用
- **安全ファイル読み込み** - `read_file_safe()`による統一されたファイル読み込み
- **セキュリティ検証の統一** - 全MCPツールでの一貫したパス検証
- **パス解決の統一** - `path_resolver.resolve()`による一貫したパス処理

### 3. 検索機能の強化
- **ファイルモード最適化** - search_contentツールでの効率的なファイルパス解決（358行〜）
- **絶対パス変換** - 相対パスを絶対パスに変換してripgrepに渡す
- **エンコーディングログ** - エンコーディング正規化の詳細ログ出力

### 4. 包括的テストとデモンストレーション
- **包括的テストカバレッジ** - 様々なエンコーディングとファイルパスシナリオのテスト
- **デモンストレーションと文書化** - エンコーディング・ファイル処理機能の実証

## 利益
- **国際サポートの向上** - 日本語（Shift_JIS、CP932）、中国語（GBK）、ヨーロッパ言語（Latin-1）ファイルの処理
- **堅牢性の強化** - UnicodeDecodeErrorクラッシュとファイル処理エラーの排除
- **セキュリティの向上** - 統一されたファイルパス検証によるセキュリティホールの防止
- **検索機能の改善** - 様々なエンコーディングのファイルでのコンテンツ検索を可能に
- **パフォーマンスの向上** - 効率的なファイルパス解決とキャッシュ機能
- **一貫した動作** - CLIとMCPインターフェース間での統一動作
- **保守性の向上** - 統一されたファイル処理APIによる保守性向上
- **デバッグ性の向上** - 詳細なログ出力による問題診断の容易化

## 影響評価
- **リスクレベル**: 低 - 変更は追加的でフォールバック機構を含む
- **破壊的変更**: なし - 後方互換性を維持
- **パフォーマンス影響**: 最小限 - エンコーディング検出はキャッシュされ、ファイル処理は最適化される
- **テストカバレッジ**: 高 - 包括的テストスイートを含む

## 実装範囲

### コア機能
- コアエンコーディングユーティリティの強化
- 統一ファイル処理APIの実装
- セキュリティ検証の標準化
- パス解決の統一化

### 言語プラグイン
- 言語プラグインの修正（Java、JavaScript、Python）
- 統一されたファイル読み込みとエラーハンドリング

### MCPシステム
- MCPサーバーとツールの更新
- 統一されたファイルパス検証とセキュリティチェック
- 検索コンテンツツールの改善（ファイルパス解決最適化）
- ripgrepコマンド構築の強化

### 検索機能の具体的改善
- **ファイルモード処理** (search_content_tool.py:358-367)
  - 相対パスの絶対パス変換
  - `path_resolver.resolve()`による統一パス解決
  - ripgrepへの最適化されたファイルリスト渡し
- **エンコーディングログ** (search_content_tool.py:420-425)
  - エンコーディング正規化プロセスの可視化
  - デバッグ情報の詳細出力

### テストと文書化
- 包括的テストスイート
- 文書化と例
- デモンストレーションスクリプト

## 成功基準

### 機能成功
1. 全ての言語プラグインが様々なエンコーディングをエラーなしで処理
2. 検索コンテンツツールがShift_JISやその他のエンコーディングで動作
3. 全MCPツールで統一されたファイルパス検証とセキュリティチェック
4. 統一されたエラーハンドリングとユーザーフレンドリーなエラーメッセージ
5. 効率的なファイルパス解決による検索パフォーマンス向上

### 品質成功
1. エンコーディング・ファイル処理シナリオの包括的テストカバレッジ（>90%）
2. 既存APIへの破壊的変更ゼロ
3. 典型的な使用ケースでのパフォーマンス影響<5%
4. セキュリティ脆弱性の排除
5. デバッグ性の大幅向上

### 保守性成功
1. 統一されたファイル処理APIによるコード重複の削減
2. 一貫したエラーハンドリングパターン
3. 明確な責任分離とモジュール化
4. 効率的なパス解決による処理速度向上
