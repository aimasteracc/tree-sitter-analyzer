# encoding-support Specification

## Purpose
多様なファイルエンコーディングの包括的サポートと統一されたファイル処理機能をtree-sitter-analyzerシステム全体で提供し、国際的なソースコードファイルの堅牢な分析を可能にする。

## Requirements

### Requirement: 安全なエンコーディング検出

システムは多様なファイルエンコーディングを自動検出し、安全に処理しなければならない（MUST）。

#### Scenario: Shift_JISファイルの自動検出と処理

**Given** Shift_JISエンコーディングで保存されたJavaソースファイルが存在する場合
**When** ファイル分析APIを呼び出す
**Then** エンコーディングが自動検出される
**And** UnicodeDecodeErrorが発生しない
**And** ファイル内容が正常に解析される
**And** 日本語コメントが正しく処理される

#### Scenario: CP932ファイルの自動検出と処理

**Given** CP932エンコーディングで保存されたPythonソースファイルが存在する場合
**When** ファイル分析APIを呼び出す
**Then** エンコーディングが自動検出される
**And** UnicodeDecodeErrorが発生しない
**And** ファイル内容が正常に解析される
**And** 日本語文字列が正しく処理される

#### Scenario: Latin-1ファイルの自動検出と処理

**Given** Latin-1エンコーディングで保存されたJavaScriptソースファイルが存在する場合
**When** ファイル分析APIを呼び出す
**Then** エンコーディングが自動検出される
**And** UnicodeDecodeErrorが発生しない
**And** ファイル内容が正常に解析される
**And** フランス語文字が正しく処理される

### Requirement: 統一ファイル処理システム

システムは全コンポーネントで統一されたファイル処理APIを使用し、一貫したファイル検証とエラーハンドリングを提供しなければならない（MUST）。

#### Scenario: validate_file APIの統一使用

**Given** 任意のコンポーネントでファイル検証が必要な場合
**When** validate_file()関数を呼び出す
**Then** 統一された検証ロジックが実行される
**And** ファイル存在、読み取り可能性、言語サポートが確認される
**And** 一貫したレスポンス形式が返される
**And** エンコーディング検出が安全に実行される

#### Scenario: read_file_safe APIの統一使用

**Given** 任意のコンポーネントでファイル読み込みが必要な場合
**When** read_file_safe()関数を呼び出す
**Then** 自動エンコーディング検出が実行される
**And** 安全なファイル読み込みが実行される
**And** エンコーディング情報が返される
**And** エラー時に適切なフォールバックが実行される

#### Scenario: MCPツール間での統一ファイル処理

**Given** 複数のMCPツールが同じファイルを処理する場合
**When** 各ツールでファイル処理を実行する
**Then** 全ツールで同じファイル検証ロジックが使用される
**And** 同じセキュリティチェックが適用される
**And** 一貫したエラーメッセージが返される
**And** 同じエンコーディング検出結果が得られる

### Requirement: 統一パス解決システム

システムは全コンポーネントで統一されたパス解決機能を使用し、一貫したファイルパス処理を提供しなければならない（MUST）。

#### Scenario: path_resolver.resolve()の統一使用

**Given** 任意のコンポーネントでファイルパス解決が必要な場合
**When** path_resolver.resolve()関数を呼び出す
**Then** 統一されたパス解決ロジックが実行される
**And** 相対パスが適切に絶対パスに変換される
**And** パス正規化が実行される
**And** 一貫したパス形式が返される

#### Scenario: search_contentツールでのファイルパス最適化

**Given** search_contentツールでファイルリストが指定された場合
**When** ファイルモード処理を実行する（358-367行）
**Then** 各ファイルパスがpath_resolver.resolve()で解決される
**And** 相対パスが絶対パスに変換される
**And** 解決されたパスがripgrepに直接渡される
**And** パス解決の効率性が向上する

#### Scenario: 相対パスと絶対パスの統一処理

**Given** 相対パスと絶対パスが混在するファイルリストが指定された場合
**When** 統一パス解決を実行する
**Then** 全てのパスが絶対パス形式に統一される
**And** パス形式の不一致によるエラーが防止される
**And** 一貫したファイル処理が実行される

### Requirement: エンコーディングキャッシュ最適化

システムはエンコーディング検出結果をキャッシュし、パフォーマンスを最適化しなければならない（MUST）。

#### Scenario: エンコーディング検出結果のキャッシュ

**Given** 同一ファイルに対して複数回のエンコーディング検出が実行される場合
**When** 最初の検出後に同じファイルを再度読み込む
**Then** キャッシュされたエンコーディング情報が使用される
**And** 検出処理がスキップされる
**And** パフォーマンスが向上する

#### Scenario: キャッシュのTTL管理

**Given** エンコーディングキャッシュにTTL（Time To Live）が設定されている場合
**When** TTL期限が経過した後にファイルを読み込む
**Then** キャッシュエントリが無効化される
**And** 新しいエンコーディング検出が実行される
**And** 最新の検出結果がキャッシュされる

#### Scenario: キャッシュサイズ制限

**Given** エンコーディングキャッシュに最大サイズ制限が設定されている場合
**When** キャッシュサイズが上限に達する
**Then** 最も古いエントリが削除される
**And** 新しいエントリが追加される
**And** メモリ使用量が制限内に保たれる

### Requirement: Ripgrepエンコーディング正規化

検索機能はripgrepツールとの互換性のためにエンコーディング名を正規化し、詳細なログを提供しなければならない（MUST）。

#### Scenario: Shift_JISエンコーディング名の正規化

**Given** search_contentツールで"Shift_JIS"エンコーディングパラメータが指定された場合
**When** ripgrepコマンドが構築される
**Then** エンコーディング名が"shift-jis"に正規化される
**And** ripgrepコマンドに"--encoding shift-jis"が含まれる
**And** 検索が正常に実行される

#### Scenario: エンコーディング正規化ログの出力

**Given** search_contentツールでエンコーディングパラメータが指定された場合
**When** エンコーディング正規化が実行される（420-425行）
**Then** 元のエンコーディング名がログに記録される
**And** 正規化後のエンコーディング名がログに記録される
**And** 正規化が実行された理由がログに記録される
**And** デバッグ情報が詳細に出力される

#### Scenario: UTF-8エンコーディング名の正規化

**Given** search_contentツールで"UTF-8"エンコーディングパラメータが指定された場合
**When** ripgrepコマンドが構築される
**Then** エンコーディング名が"utf-8"に正規化される
**And** ripgrepコマンドに"--encoding utf-8"が含まれる
**And** 検索が正常に実行される

#### Scenario: Latin-1エンコーディング名の正規化

**Given** search_contentツールで"iso-8859-1"エンコーディングパラメータが指定された場合
**When** ripgrepコマンドが構築される
**Then** エンコーディング名が"latin1"に正規化される
**And** ripgrepコマンドに"--encoding latin1"が含まれる
**And** 検索が正常に実行される

### Requirement: 統一セキュリティ検証

全てのファイル処理において統一されたセキュリティ検証が実行されなければならない（MUST）。

#### Scenario: MCPツールでの統一セキュリティ検証

**Given** MCPツールでファイルパスが指定された場合
**When** ファイル処理を実行する
**Then** SecurityValidator.validate_file_path()が呼び出される
**And** プロジェクト境界内のパスであることが確認される
**And** パストラバーサル攻撃が防止される
**And** ファイルアクセス権限が確認される

#### Scenario: 言語プラグインでの統一セキュリティ検証

**Given** 言語プラグインでファイル分析が実行される場合
**When** ファイル読み込みを実行する
**Then** 統一されたセキュリティチェックが実行される
**And** 不正なファイルパスが拒否される
**And** セキュリティエラーが適切に報告される

#### Scenario: 不正ファイルパスの検出と拒否

**Given** プロジェクト境界外のファイルパスが指定された場合
**When** ファイル処理を実行する
**Then** セキュリティ検証でエラーが発生する
**And** 明確なセキュリティエラーメッセージが返される
**And** ファイルアクセスが拒否される
**And** セキュリティログが記録される

### Requirement: 言語プラグインエンコーディング対応

全ての言語プラグインは多様なエンコーディングのファイルを処理できなければならない（MUST）。

#### Scenario: Javaプラグインの多様エンコーディング対応

**Given** Shift_JISエンコーディングのJavaファイルが存在する場合
**When** Javaプラグインでファイルを分析する
**Then** read_file_safe()が使用される
**And** エンコーディングが自動検出される
**And** ファイル内容が正常に読み込まれる
**And** クラス、メソッド、フィールドが正しく抽出される
**And** 日本語コメントが保持される

#### Scenario: JavaScriptプラグインの多様エンコーディング対応

**Given** Latin-1エンコーディングのJavaScriptファイルが存在する場合
**When** JavaScriptプラグインでファイルを分析する
**Then** read_file_safe()が使用される
**And** エンコーディングが自動検出される
**And** ファイル内容が正常に読み込まれる
**And** 関数、クラス、変数が正しく抽出される
**And** フランス語文字列が保持される

#### Scenario: Pythonプラグインの多様エンコーディング対応

**Given** CP932エンコーディングのPythonファイルが存在する場合
**When** Pythonプラグインでファイルを分析する
**Then** read_file_safe()が使用される
**And** エンコーディングが自動検出される
**And** ファイル内容が正常に読み込まれる
**And** クラス、関数、変数が正しく抽出される
**And** 日本語docstringが保持される

### Requirement: MCPツール統一処理

全てのMCPツールは統一されたファイル処理とエンコーディング対応を実装しなければならない（MUST）。

#### Scenario: analyze_code_structureツールの統一処理

**Given** Shift_JISエンコーディングのソースファイルが存在する場合
**When** analyze_code_structureツールを実行する
**Then** 統一されたファイル検証が実行される
**And** read_file_safe()でエンコーディングが自動検出される
**And** ファイル構造が正常に分析される
**And** 日本語要素名が正しく表示される
**And** エラーが発生しない

#### Scenario: check_code_scaleツールの統一処理

**Given** CP932エンコーディングのソースファイルが存在する場合
**When** check_code_scaleツールを実行する
**Then** 統一されたセキュリティ検証が実行される
**And** read_file_safe()でエンコーディングが自動検出される
**And** ファイルサイズと複雑度が正常に計算される
**And** 日本語コメントが行数に正しく含まれる
**And** エラーが発生しない

#### Scenario: search_contentツールの統一処理

**Given** Latin-1エンコーディングのソースファイルが存在する場合
**When** search_contentツールで検索を実行する
**Then** ファイル検証が統一的に実行される
**And** エンコーディングパラメータが正規化される
**And** ripgrepが正しいエンコーディングで実行される
**And** フランス語文字列が正しく検索される
**And** 検索結果が正常に返される

#### Scenario: search_contentツールのファイルモード最適化

**Given** 複数のファイルパスが指定された場合
**When** search_contentツールのファイルモード処理を実行する
**Then** 各ファイルパスがpath_resolver.resolve()で解決される
**And** 相対パスが絶対パスに変換される
**And** 解決されたファイルリストがripgrepに直接渡される
**And** パス解決のオーバーヘッドが最小化される
**And** 検索パフォーマンスが向上する

#### Scenario: query_toolの統一処理

**Given** 様々なエンコーディングのソースファイルが存在する場合
**When** query_toolでクエリを実行する
**Then** 統一されたセキュリティ検証が実行される
**And** read_file_safe()でファイルが安全に読み込まれる
**And** エンコーディングに関係なくクエリが正常に実行される
**And** 一貫したレスポンス形式が返される

### Requirement: 後方互換性保証

エンコーディング対応とファイル処理の統一は既存のAPIや動作を変更せず、完全な後方互換性を維持しなければならない（MUST）。

#### Scenario: 既存UTF-8ファイルの処理継続

**Given** UTF-8エンコーディングのソースファイルが存在する場合
**When** 既存のAPI関数を呼び出す
**Then** 従来と同じ結果が返される
**And** パフォーマンスの大幅な劣化がない
**And** エラーが発生しない
**And** レスポンス形式が変更されない

#### Scenario: 既存APIパラメータの動作保持

**Given** エンコーディング対応前のAPIコールが存在する場合
**When** 同じパラメータで新しいシステムを呼び出す
**Then** 同一の結果が返される
**And** 新しいエラーが発生しない
**And** レスポンス時間が許容範囲内である
**And** メモリ使用量が大幅に増加しない

#### Scenario: 既存ファイルパス処理の継続

**Given** 既存のファイルパス指定方法が使用される場合
**When** 新しい統一ファイル処理システムで処理する
**Then** 従来と同じファイルが正しく処理される
**And** パス解決ロジックが期待通りに動作する
**And** セキュリティ制限が適切に適用される
**And** エラーメッセージが改善される

### Requirement: エラーハンドリング強化

エンコーディング・ファイル処理関連のエラーは適切に処理され、明確なエラーメッセージを提供しなければならない（MUST）。

#### Scenario: 不正なエンコーディングファイルの処理

**Given** 破損したエンコーディングのファイルが存在する場合
**When** ファイル分析を実行する
**Then** システムがクラッシュしない
**And** 適切なフォールバック処理が実行される
**And** 明確なエラーメッセージが返される
**And** 部分的な結果が可能な限り返される

#### Scenario: ファイルアクセス権限エラーの処理

**Given** 読み取り権限のないファイルが指定された場合
**When** ファイル処理を実行する
**Then** 統一されたエラーハンドリングが実行される
**And** 明確な権限エラーメッセージが返される
**And** セキュリティログが記録される
**And** システムが継続して動作する

#### Scenario: サポートされていないエンコーディングの処理

**Given** 非常に稀なエンコーディングのファイルが存在する場合
**When** ファイル分析を実行する
**Then** デフォルトエンコーディング（UTF-8）でフォールバック処理される
**And** 警告メッセージが記録される
**And** 可能な限りの分析結果が返される
**And** システムが継続して動作する

### Requirement: パフォーマンス最適化

エンコーディング検出とファイル処理は既存のパフォーマンスに大きな影響を与えてはならない（MUST）。

#### Scenario: UTF-8ファイルの高速処理

**Given** UTF-8エンコーディングのファイル（一般的なケース）を処理する場合
**When** ファイル分析を実行する
**Then** エンコーディング検出のオーバーヘッドが5%未満である
**And** キャッシュが効果的に機能する
**And** 従来のパフォーマンスが維持される
**And** 統一ファイル処理による遅延が最小限である

#### Scenario: 大量ファイル処理時のキャッシュ効果

**Given** 同じエンコーディングの複数ファイルを処理する場合
**When** 連続してファイル分析を実行する
**Then** 2回目以降の処理でキャッシュが使用される
**And** エンコーディング検出処理がスキップされる
**And** ファイル検証処理が最適化される
**And** 全体的な処理時間が短縮される

#### Scenario: 統一ファイル処理のパフォーマンス

**Given** 統一ファイル処理APIが使用される場合
**When** 大量のファイル処理を実行する
**Then** 処理の重複が排除される
**And** セキュリティチェックが効率的に実行される
**And** メモリ使用量が最適化される
**And** 全体的なスループットが向上する

#### Scenario: パス解決の効率化

**Given** search_contentツールで大量のファイルが指定された場合
**When** ファイルパス解決を実行する
**Then** path_resolver.resolve()が効率的に実行される
**And** パス解決のオーバーヘッドが最小化される
**And** 絶対パス変換が高速に実行される
**And** ripgrepへのファイル渡しが最適化される

### Requirement: 国際化対応強化

システムは主要な国際エンコーディングを包括的にサポートしなければならない（MUST）。

#### Scenario: 日本語エンコーディングの包括サポート

**Given** 日本語ソースファイルが様々なエンコーディング（Shift_JIS、CP932、EUC-JP）で存在する場合
**When** それぞれのファイルを分析する
**Then** 全てのエンコーディングが正しく検出される
**And** 日本語文字が正しく処理される
**And** 文字化けが発生しない
**And** 分析結果に日本語が正しく含まれる

#### Scenario: 中国語エンコーディングの包括サポート

**Given** 中国語ソースファイルが様々なエンコーディング（GBK、GB2312、GB18030）で存在する場合
**When** それぞれのファイルを分析する
**Then** 全てのエンコーディングが正しく検出される
**And** 中国語文字が正しく処理される
**And** 文字化けが発生しない
**And** 分析結果に中国語が正しく含まれる

#### Scenario: ヨーロッパ言語エンコーディングの包括サポート

**Given** ヨーロッパ言語ソースファイルが様々なエンコーディング（Latin-1、CP1252）で存在する場合
**When** それぞれのファイルを分析する
**Then** 全てのエンコーディングが正しく検出される
**And** アクセント文字が正しく処理される
**And** 文字化けが発生しない
**And** 分析結果にアクセント文字が正しく含まれる

### Requirement: デバッグ性向上

システムはエンコーディング処理とファイル処理の詳細なログを提供し、問題診断を容易にしなければならない（MUST）。

#### Scenario: エンコーディング正規化ログの詳細出力

**Given** エンコーディングパラメータが指定された場合
**When** エンコーディング正規化が実行される
**Then** 元のエンコーディング名がログに記録される
**And** 正規化後のエンコーディング名がログに記録される
**And** 正規化の理由がログに記録される
**And** ripgrep互換性情報がログに記録される

#### Scenario: ファイルパス解決ログの出力

**Given** ファイルパス解決が実行される場合
**When** path_resolver.resolve()が呼び出される
**Then** 元のパスがログに記録される
**And** 解決後のパスがログに記録される
**And** パス解決の詳細がログに記録される
**And** セキュリティチェック結果がログに記録される

#### Scenario: エラー診断情報の充実

**Given** ファイル処理でエラーが発生した場合
**When** エラーハンドリングが実行される
**Then** 詳細なエラー情報がログに記録される
**And** エラー発生箇所が特定される
**And** 推奨される対処法がログに記録される
**And** デバッグに必要な情報が完全に提供される

### Requirement: テストカバレッジ保証

エンコーディング対応とファイル処理機能は包括的なテストスイートでカバーされなければならない（MUST）。

#### Scenario: エンコーディング検出テストの包括性

**Given** エンコーディング検出機能のテストスイートが存在する場合
**When** テストスイートを実行する
**Then** 主要なエンコーディング（UTF-8、Shift_JIS、CP932、Latin-1、GBK）がテストされる
**And** エッジケース（空ファイル、バイナリファイル、破損ファイル）がテストされる
**And** テストカバレッジが90%以上である
**And** 全てのテストが通過する

#### Scenario: 統一ファイル処理テストの包括性

**Given** 統一ファイル処理機能のテストスイートが存在する場合
**When** テストスイートを実行する
**Then** 全てのファイル処理APIがテストされる
**And** セキュリティ検証がテストされる
**And** パス解決機能がテストされる
**And** エラーハンドリングがテストされる
**And** パフォーマンステストが実行される
**And** 全てのテストが通過する

#### Scenario: MCPツール統合テストの包括性

**Given** MCPツールの統合テストが存在する場合
**When** テストスイートを実行する
**Then** 各MCPツールで統一ファイル処理がテストされる
**And** エンコーディング対応がテストされる
**And** セキュリティ機能がテストされる
**And** パス解決機能がテストされる
**And** エラーケースがテストされる
**And** 全てのテストが通過する

#### Scenario: 検索機能の包括テスト

**Given** search_contentツールのテストスイートが存在する場合
**When** テストスイートを実行する
**Then** ファイルモード処理がテストされる
**And** エンコーディング正規化がテストされる
**And** パス解決最適化がテストされる
**And** ログ出力機能がテストされる
**And** 全てのテストが通過する
