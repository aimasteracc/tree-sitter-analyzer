# 設計: エンコーディングサポートとファイル処理の強化

## アーキテクチャ概要

この強化は、tree-sitter-analyzerフレームワーク全体にわたる統一エンコーディングサポートシステムと統一ファイル処理システムを実装し、複数レイヤーでのエンコーディング互換性問題とファイル処理の一貫性問題に対処する。

## システムコンポーネント

### 1. コアエンコーディング層 (`encoding_utils.py`)
**既に実装済み** - 全てのエンコーディング操作の基盤を提供：

```
EncodingManager
├── safe_encode() - 堅牢なテキスト→バイト変換
├── safe_decode() - 堅牢なバイト→テキスト変換  
├── detect_encoding() - キャッシュ付き自動エンコーディング検出
├── read_file_safe() - エンコーディング検出付き安全ファイル読み込み
└── normalize_line_endings() - クロスプラットフォーム改行処理

EncodingCache
├── スレッドセーフキャッシュ（パフォーマンス向上）
├── TTLベース有効期限
└── ファイルパスベース最適化
```

### 2. 統一ファイル処理層 (`api.py`, `security/validator.py`)
**強化済み** - 全コンポーネントで統一されたファイル処理：

```
統一ファイル処理API
├── validate_file() - 標準化されたファイル検証
├── read_file_safe() - 安全なエンコーディング検出付きファイル読み込み
├── SecurityValidator.validate_file_path() - 統一セキュリティ検証
└── 一貫したエラーハンドリング
```

### 3. Ripgrep統合層 (`fd_rg_utils.py`)
**新規強化** - ripgrep互換性のためのエンコーディング名正規化：

```
normalize_encoding_name()
├── Shift_JIS系: "Shift_JIS" → "shift-jis"
├── UTF系: "UTF-8" → "utf-8"
├── Latin系: "latin-1" → "latin1"
├── 中国語系: "GB2312" → "gbk"
└── フォールバック: 不明な場合は元の値を返す
```

### 4. 言語プラグイン層
**強化済み** - 全プラグインで統一されたファイル処理：

```
言語プラグイン (Java, JavaScript, Python)
├── ハードコーディングされたUTF-8をread_file_safe()に置換
├── 自動エンコーディング検出
├── 統一されたファイル存在チェック
├── 優雅なフォールバック処理
└── 一貫したエラー報告
```

### 5. MCPツール層
**強化済み** - MCPサーバーとツールで統一されたファイル処理：

```
MCPコンポーネント
├── server.py - 統一されたファイル検証とセキュリティチェック
├── analyze_scale_tool.py - 安全なファイル読み込みとパス検証
├── search_content_tool.py - ファイル検証とエンコーディング正規化
├── query_tool.py - 統一されたセキュリティ検証
├── read_partial_tool.py - 安全なパス解決と検証
└── universal_analyze_tool.py - 統一されたファイル処理
```

## データフロー

### 統一ファイル読み込みフロー
```
ファイルパス → セキュリティ検証 → パス解決 → 
ファイル存在チェック → read_file_safe() → EncodingCacheチェック → 
エンコーディング検出 → 安全デコード → 正規化コンテンツ
```

### MCPツール統一処理フロー
```
MCPリクエスト → パラメータ検証 → ファイルパス抽出 → 
SecurityValidator.validate_file_path() → パス解決 → 
read_file_safe() → 処理実行 → 統一レスポンス
```

### 検索コンテンツフロー
```
検索リクエスト → ファイル検証 → エンコーディングパラメータ → 
normalize_encoding_name() → ripgrepコマンド → 安全結果処理 → レスポンス
```

### 言語分析フロー
```
ファイルパス → validate_file() → read_file_safe() → Tree-sitterパース → 
要素抽出 → 安全テキスト処理 → 分析結果
```

## 主要設計決定

### 1. 統一API戦略
- **統一ファイル検証** - `validate_file()`の標準化
- **統一ファイル読み込み** - `read_file_safe()`の全コンポーネント採用
- **統一セキュリティ検証** - `SecurityValidator.validate_file_path()`の一貫使用
- **統一エラーハンドリング** - 一貫したエラーメッセージとフォールバック

### 2. 後方互換性戦略
- **破壊的変更なし** - 既存APIへの変更なし
- **追加的強化のみ** - 機能追加のみ
- **サポートされていないエンコーディングの優雅なフォールバック**
- **デフォルトUTF-8動作の保持**

### 3. パフォーマンス最適化
- **ファイルベースエンコーディングキャッシュ** - 重複検出の回避
- **スレッドセーフキャッシュ実装** - 並行アクセス対応
- **TTLベース有効期限** - ファイル変更への対応
- **UTF-8ファイルの最小オーバーヘッド**（高速パス）
- **統一ファイル処理による重複排除**

### 4. セキュリティ強化戦略
- **統一パス検証** - 全MCPツールで一貫したセキュリティチェック
- **プロジェクト境界の厳格な実施** - SecurityValidatorによる境界チェック
- **パストラバーサル攻撃の防止** - 統一されたパス解決ロジック
- **ファイルアクセス権限の検証** - 読み取り可能性の事前チェック

### 5. エラーハンドリング戦略
- **優雅な劣化** - エンコーディング・ファイル問題でクラッシュしない
- **包括的ログ** - デバッグ用の詳細ログ
- **フォールバックチェーン** - 最大互換性のため
- **明確なエラーメッセージ** - ユーザーフレンドリーなトラブルシューティング
- **統一エラー形式** - 全コンポーネントで一貫したエラーレスポンス

### 6. テスト戦略
- **包括的エンコーディングカバレッジ** - Shift_JIS、CP932、Latin-1、GBK
- **ファイルパス処理テスト** - 様々なパスパターンとエッジケース
- **セキュリティテスト** - パストラバーサルとアクセス制御
- **統合テスト** - 全コンポーネント横断
- **パフォーマンス回帰テスト**
- **クロスプラットフォーム検証**

## 実装フェーズ

### フェーズ1: コアインフラストラクチャ ✅
- キャッシュ付きencoding_utils.pyの強化
- 統一ファイル処理APIの実装
- ripgrepエンコーディング正規化
- 基本テストカバレッジ

### フェーズ2: システム統合 ✅  
- 言語プラグインの更新（統一ファイル処理採用）
- MCPサーバーとツールの更新（統一セキュリティ検証）
- API層の更新（validate_file強化）

### フェーズ3: テストと文書化 ✅
- 包括的テストスイート（エンコーディング + ファイル処理）
- デモンストレーションスクリプト
- パフォーマンス検証

## リスク軽減

### 1. エンコーディング検出精度
- **リスク**: 不正確なエンコーディング検出
- **軽減策**: 信頼度閾値、フォールバックチェーン、キャッシュ

### 2. ファイル処理パフォーマンス
- **リスク**: 統一処理によるオーバーヘッド
- **軽減策**: 積極的キャッシュ、高速パス、最適化されたセキュリティチェック

### 3. セキュリティ回帰
- **リスク**: 統一化によるセキュリティホールの導入
- **軽減策**: 広範囲セキュリティテスト、既存セキュリティ機能の保持

### 4. 互換性問題
- **リスク**: 既存ワークフローの破壊
- **軽減策**: 広範囲テスト、後方互換性保証、段階的ロールアウト

### 5. メモリ使用量
- **リスク**: エンコーディングキャッシュとファイル処理のメモリ消費
- **軽減策**: サイズ制限、TTL有効期限、効率的なクリーンアップ機構

## 監視と検証

### 成功指標
1. **本番環境でのUnicodeDecodeErrorクラッシュゼロ**
2. **ファイル処理エラーの大幅削減**
3. **典型的なUTF-8ファイルでのパフォーマンス影響<5%**
4. **テストファイルでのエンコーディング検出精度>95%**
5. **既存APIとの後方互換性100%**
6. **セキュリティ脆弱性ゼロ**

### 検証アプローチ
1. **単体テスト** - 各エンコーディング・ファイル処理シナリオ用
2. **統合テスト** - 全コンポーネント横断  
3. **セキュリティテスト** - パストラバーサルとアクセス制御
4. **パフォーマンスベンチマーク** - 回帰検出用
5. **実世界ファイルテスト** - 多様なエンコーディングとパスパターンで

## 将来の考慮事項

### 潜在的拡張
1. **カスタムエンコーディングマッピング** - 特殊用途向け
2. **高度なファイル処理機能** - ストリーミング、圧縮ファイル対応
3. **エンコーディング変換ユーティリティ** - ファイル処理用
4. **エンコーディング・ファイル処理統計** - 分析用
5. **高度検出ヒューリスティック** - エッジケース用

### メンテナンス要件
1. **定期的キャッシュクリーンアップ** - 監視
2. **エンコーディング検出精度** - 追跡
3. **ファイル処理パフォーマンス** - 監視
4. **セキュリティ監査** - 定期的な脆弱性チェック
5. **新エンコーディング・ファイル形式サポート** - 必要に応じて

## アーキテクチャ利益

### 保守性向上
- **コード重複の削減** - 統一されたファイル処理API
- **一貫したエラーハンドリング** - 予測可能な動作
- **明確な責任分離** - 各層の役割が明確

### 拡張性向上
- **新しいエンコーディングの容易な追加**
- **新しいファイル形式への対応**
- **新しいセキュリティ要件への適応**

### 信頼性向上
- **統一されたテスト戦略**
- **包括的エラーハンドリング**
- **堅牢なセキュリティ機能**
