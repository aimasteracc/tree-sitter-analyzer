# Test Coverage Check Workflow
#
# Purpose: Run comprehensive test suite with coverage reporting and threshold checks
# Triggers: Pull requests, push to main/develop branches, manual dispatch
# Jobs:
#   - coverage-check: Run tests with coverage and enforce minimum thresholds
# Secrets Required:
#   - CODECOV_TOKEN: For coverage upload to Codecov

name: Test Coverage Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'

env:
  COVERAGE_THRESHOLD: 40  # Minimum coverage percentage (adjust as needed)
  COVERAGE_THRESHOLD_FAIL: false  # Set to true to fail CI on low coverage

jobs:
  coverage-check:
    name: Coverage Check (Python ${{ inputs.python-version || '3.11' }})
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python ${{ inputs.python-version || '3.11' }}
      run: uv python install ${{ inputs.python-version || '3.11' }}

    - name: Setup System Dependencies
      uses: ./.github/actions/setup-system
      with:
        os: ubuntu-latest

    - name: Install dependencies
      run: |
        uv sync --all-extras
      shell: bash

    - name: Run Tests with Coverage
      id: test-coverage
      run: |
        echo "### ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ inputs.python-version || '3.11' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Coverage Threshold:** ${{ env.COVERAGE_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Run tests with coverage
        uv run pytest tests/ -n auto -v --tb=short --maxfail=10 \
          --cov=tree_sitter_analyzer \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-report=term \
          -m "not requires_ripgrep or not requires_fd" \
          --cov-fail-under=${{ env.COVERAGE_THRESHOLD_FAIL == 'true' && env.COVERAGE_THRESHOLD || 0 }} \
          > pytest-coverage-output.txt 2>&1 || touch test_failed

        # Extract coverage percentage
        COVERAGE_PERCENT=$(uv run python -c "
        import re
        with open('pytest-coverage-output.txt', 'r') as f:
            content = f.read()
            match = re.search(r'TOTAL\s+\d+\s+\d+\s+(\d+)%', content)
            if match:
                print(match.group(1))
            else:
                print('0')
        " || echo "0")

        echo "COVERAGE_PERCENT=$COVERAGE_PERCENT" >> $GITHUB_ENV

        # Display coverage in summary
        echo '```text' >> $GITHUB_STEP_SUMMARY
        tail -n 30 pytest-coverage-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        # Check if coverage meets threshold
        if [ "$COVERAGE_PERCENT" -lt "${{ env.COVERAGE_THRESHOLD }}" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Coverage Warning:** Current coverage ($COVERAGE_PERCENT%) is below threshold (${{ env.COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.COVERAGE_THRESHOLD_FAIL }}" == "true" ]; then
            echo "âŒ **Coverage Check Failed!**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Coverage Check Passed:** $COVERAGE_PERCENT% (threshold: ${{ env.COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
        fi

        # Check if tests failed
        if [ -f test_failed ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Tests Failed!**" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
      shell: bash

    - name: Generate Coverage Report
      if: always()
      run: |
        echo "### ðŸ“ˆ Coverage Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Generate coverage summary
        uv run python scripts/monitor_coverage.py summary >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Coverage summary generation completed"

        # Show low coverage files
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Low Coverage Files (< 50%)" >> $GITHUB_STEP_SUMMARY
        echo '```text' >> $GITHUB_STEP_SUMMARY
        uv run python scripts/monitor_coverage.py low --threshold 50 >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No low coverage files found"
        echo '```' >> $GITHUB_STEP_SUMMARY
      shell: bash

    - name: Upload Coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-coverage-check
        fail_ci_if_error: false
        verbose: true

    - name: Upload Coverage HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html-report
        path: htmlcov/
        retention-days: 7

    - name: Upload Coverage XML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-xml-report
        path: coverage.xml
        retention-days: 7

    - name: Comment Coverage on PR
      if: github.event_name == 'pull_request' && always()
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ github.token }}
        MINIMUM_GREEN: ${{ env.COVERAGE_THRESHOLD }}
        MINIMUM_ORANGE: 30

    - name: Coverage Trend Analysis
      if: always()
      run: |
        echo "### ðŸ“Š Coverage Trend" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```text' >> $GITHUB_STEP_SUMMARY
        uv run python scripts/monitor_coverage.py trend >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Trend data not available"
        echo '```' >> $GITHUB_STEP_SUMMARY
      shell: bash
