name: Format Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC to catch format regressions
    - cron: '0 2 * * *'

jobs:
  format-validation:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --all-extras --dev

    - name: Run format validation tests
      run: |
        uv run pytest tests/format_testing/ -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run format regression tests
      run: |
        uv run pytest tests/test_format_regression_v1_6_1_4.py -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run cross-component format validation
      run: |
        uv run pytest tests/format_testing/cross_component_tests.py -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run specification compliance tests
      run: |
        uv run pytest tests/format_testing/specification_compliance_tests.py -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run format contract tests
      run: |
        uv run pytest tests/format_testing/format_contract_tests.py -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run format monitoring tool
      if: always()
      run: |
        mkdir -p ./monitoring-reports
        uv run python scripts/format_monitoring_tool.py --directory examples --report-only --output-dir ./monitoring-reports
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Run pre-commit format validation
      if: always()
      run: |
        # Note: This script requires files as arguments, but we don't have modified files in CI
        # Skipping pre-commit validation in CI - it's meant for local use
        echo "Pre-commit validation is designed for local use with modified files"
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Generate format change report
      if: always()
      run: |
        uv run python scripts/format_change_management.py report --output ./monitoring-reports/format_change_report.json
      env:
        PYTHONPATH: ${{ github.workspace }}

    # Note: generate_format_report.py does not exist - disabled temporarily
    # - name: Generate format validation report
    #   if: always()
    #   run: |
    #     uv run python scripts/generate_format_report.py --output-dir ./format-reports
    #   env:
    #     PYTHONPATH: ${{ github.workspace }}

    # - name: Upload format validation report
    #   if: always()
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: format-validation-report-${{ matrix.python-version }}
    #     path: ./format-reports/
    #     retention-days: 30

    - name: Upload monitoring reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: format-monitoring-reports-${{ matrix.python-version }}
        path: ./monitoring-reports/
        retention-days: 30

    - name: Check for format regressions
      if: false  # Disabled: script does not exist yet
      run: |
        uv run python scripts/check_format_regressions.py \
          --base-ref ${{ github.event.pull_request.base.sha }} \
          --head-ref ${{ github.sha }}
      env:
        PYTHONPATH: ${{ github.workspace }}

  format-compatibility-matrix:
    runs-on: ubuntu-latest
    needs: format-validation
    if: github.event_name == 'schedule' || github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --all-extras --dev

    - name: Run format compatibility matrix tests
      run: |
        uv run python scripts/run_format_compatibility_matrix.py
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Upload compatibility matrix report
      uses: actions/upload-artifact@v4
      with:
        name: format-compatibility-matrix
        path: ./compatibility-reports/
        retention-days: 90

  format-performance-validation:
    runs-on: ubuntu-latest
    needs: format-validation
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf-test]')

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --all-extras --dev

    - name: Run format performance tests
      run: |
        uv run pytest tests/format_testing/ -k "performance" -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Generate performance report
      run: |
        uv run python scripts/generate_performance_report.py
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Upload performance report
      uses: actions/upload-artifact@v4
      with:
        name: format-performance-report
        path: ./performance-reports/
        retention-days: 30

  format-security-validation:
    runs-on: ubuntu-latest
    needs: format-validation

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --all-extras --dev

    - name: Run format security validation
      run: |
        uv run python scripts/validate_format_security.py
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Check for format injection vulnerabilities
      run: |
        uv run pytest tests/format_testing/ -k "security" -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

  notify-format-issues:
    runs-on: ubuntu-latest
    needs: [format-validation, format-compatibility-matrix]
    if: failure() && (github.event_name == 'push' || github.event_name == 'schedule')
    permissions:
      issues: write
      contents: read

    steps:
    - name: Notify format validation failure
      uses: actions/github-script@v6
      with:
        script: |
          const issue_body = `
          ## ðŸš¨ Format Validation Failure

          **Event**: ${{ github.event_name }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Workflow**: ${{ github.workflow }}

          ### Failed Jobs
          - Format Validation: ${{ needs.format-validation.result }}
          - Format Compatibility Matrix: ${{ needs.format-compatibility-matrix.result }}

          ### Action Required
          1. Review the failed workflow logs
          2. Check format validation reports in artifacts
          3. Fix any format regressions or specification violations
          4. Re-run the workflow after fixes

          ### Links
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          **Auto-generated by Format Validation Workflow**
          `;

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Format Validation Failure - ${new Date().toISOString().split('T')[0]}`,
            body: issue_body,
            labels: ['format-validation', 'bug', 'high-priority']
          });
