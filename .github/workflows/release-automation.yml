# Release Branch Automation
# Automated testing, building, and deployment for release branches

name: Release Branch Automation

on:
  push:
    branches:
      - 'release/v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    name: Validate Release
    uses: ./.github/workflows/reusable-test.yml
    with:
      python-version: "3.11"
      upload-coverage: true
    secrets: inherit # pragma: allowlist secret

  build:
    name: Prepare Distribution
    needs: test
    uses: ./.github/workflows/reusable-build.yml

  publish:
    name: Deploy to PyPI
    needs: build
    uses: ./.github/workflows/reusable-publish.yml
    secrets:
      PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

  create-main-pr:
    name: Finalize Release
    needs: [test, build, publish]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: release-to-main
          title: "ðŸš€ Release to Main: ${{ github.ref_name }}"
          body: |
            ## ðŸš€ Automated Production Release
            This PR marks the completion of the release cycle for **${{ github.ref_name }}**.

            ### âœ… Achievements
            - All quality standards met
            - Cross-platform tests passed
            - **Package successfully published to PyPI**

            ### ðŸ“¦ Release Status
            - **Version**: ${{ github.ref_name }}
            - **Environment**: Production
            - **Deployment**: Completed

            ---
            *Authoritative CI/CD Pipeline*
          delete-branch: true
          commit-message: "chore: Release ${{ github.ref_name }} to main"
