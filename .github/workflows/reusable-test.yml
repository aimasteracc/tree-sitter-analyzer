# Reusable Test Workflow
#
# Purpose: Comprehensive test suite for all branches
# Triggers: Called by branch-specific workflows
# Jobs:
#   - test-matrix: Runs tests across Python versions and OS platforms
# Secrets Required:
#   - CODECOV_TOKEN: For coverage upload

name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for coverage upload'
        required: false
        default: '3.11'
        type: string

      upload-coverage:
        description: 'Whether to upload coverage to Codecov'
        required: false
        default: true
        type: boolean

    secrets:
      CODECOV_TOKEN:
        required: true

jobs:
  test-matrix:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          # Reduce matrix size for faster CI
          - os: windows-latest
            python-version: "3.10"
          - os: macos-latest
            python-version: "3.10"

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Setup System Dependencies
      uses: ./.github/actions/setup-system
      with:
        os: ${{ matrix.os }}

    - name: Install dependencies
      run: |
        uv sync --all-extras
      shell: bash

    - name: Run Tests with Coverage
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      id: test-coverage
      run: |
        echo "### ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        uv run pytest tests/ -n auto -v --tb=short --maxfail=10 \
          --cov=tree_sitter_analyzer --cov-report=xml --cov-report=term-missing \
          -m "not requires_ripgrep or not requires_fd" > pytest-output.txt 2>&1 || touch test_failed

        cat pytest-output.txt
        echo '```text' >> $GITHUB_STEP_SUMMARY
        tail -n 20 pytest-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        if [ -f test_failed ]; then
          echo "âŒ Tests failed!" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
      shell: bash

    - name: Run Tests (no coverage)
      if: matrix.os != 'ubuntu-latest' || matrix.python-version != inputs.python-version
      run: |
        uv run pytest tests/ -n auto -v --tb=short --maxfail=10 \
          -m "not requires_ripgrep or not requires_fd"
      shell: bash

    - name: Upload coverage to Codecov
      if: inputs.upload-coverage && matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      with:
        files: ./coverage.xml
        fail_ci_if_error: false
        flags: unittests
        name: codecov-umbrella

    - name: Update README statistics
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        echo "Updating README statistics..."
        uv run python scripts/update_readme_stats.py || echo "README stats update completed with warnings"
      shell: bash
