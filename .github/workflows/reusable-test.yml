# Reusable Test Workflow
#
# Purpose: Comprehensive test suite for all branches
# Triggers: Called by branch-specific workflows

name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for coverage upload'
        required: false
        default: '3.11'
        type: string
      upload-coverage:
        description: 'Whether to upload coverage to Codecov'
        required: false
        default: true
        type: boolean
    secrets:
      CODECOV_TOKEN:
        required: true

jobs:
  test-matrix:
    name: Test Suite (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          # Optimize matrix: Run all Python versions on Linux, but only stable on others
          - os: windows-latest
            python-version: "3.10"
          - os: windows-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.10"
          - os: macos-latest
            python-version: "3.12"

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Analyzer
      uses: ./.github/actions/setup-analyzer
      with:
        os: ${{ matrix.os }}
        python-version: ${{ matrix.python-version }}
        uv-sync: "true"

    - name: Run Tests with Coverage
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        echo "### ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        uv run pytest tests/ -n auto -v --tb=short --maxfail=10 \
          --cov=tree_sitter_analyzer --cov-report=xml --cov-report=term-missing \
          2>&1 | tee pytest-output.txt || touch test_failed

        echo '```text' >> $GITHUB_STEP_SUMMARY
        tail -n 50 pytest-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        if [ -f test_failed ]; then
          echo "âŒ Tests failed!" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
      shell: bash

    - name: Run Tests (no coverage)
      if: matrix.os != 'ubuntu-latest' || matrix.python-version != inputs.python-version
      run: |
        uv run pytest tests/ -n auto -v --tb=short --maxfail=10
      shell: bash

    - name: Upload coverage to Codecov
      if: inputs.upload-coverage && matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
        flags: unittests
        name: codecov-umbrella

    - name: Update README statistics
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        uv run python scripts/update_readme_stats.py || echo "README stats update completed with warnings"
      shell: bash
