# Reusable Test Workflow
#
# Purpose: Comprehensive test suite for all branches
# Triggers: Called by branch-specific workflows
# Jobs:
#   - test-matrix: Runs tests across Python versions and OS platforms
# Secrets Required:
#   - CODECOV_TOKEN: For coverage upload

name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for coverage upload'
        required: false
        default: '3.11'
        type: string

      upload-coverage:
        description: 'Whether to upload coverage to Codecov'
        required: false
        default: true
        type: boolean

    secrets:
      CODECOV_TOKEN:
        required: true

jobs:
  test-matrix:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          # Reduce matrix size for faster CI
          - os: windows-latest
            python-version: "3.10"
          - os: macos-latest
            python-version: "3.10"

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Install fd and ripgrep for MCP tools
        sudo apt-get update
        sudo apt-get install -y fd-find ripgrep
        # Create symlink for fd command (Ubuntu packages it as fdfind)
        sudo ln -sf /usr/bin/fdfind /usr/bin/fd
      shell: bash

    - name: Install system dependencies (macOS)
      if: startsWith(matrix.os, 'macos-')
      run: |
        # Install fd and ripgrep for MCP tools
        brew install fd ripgrep
      shell: bash

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # Install fd and ripgrep for MCP tools
        choco install fd ripgrep -y
      shell: powershell

    - name: Install dependencies
      run: |
        uv sync --all-extras
      shell: bash

    - name: Run pre-commit quality checks
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        uv run python check_quality.py --new-code-only || echo "Quality checks completed with warnings"
      shell: bash

    - name: Run tests with coverage
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        uv run pytest tests/ -v --tb=short --maxfail=10 \
          --cov=tree_sitter_analyzer --cov-report=xml --cov-report=term-missing \
          -m "not requires_ripgrep or not requires_fd"
      shell: bash

    - name: Run tests (no coverage)
      if: matrix.os != 'ubuntu-latest' || matrix.python-version != inputs.python-version
      run: |
        uv run pytest tests/ -v --tb=short --maxfail=10 \
          -m "not requires_ripgrep or not requires_fd"
      shell: bash

    - name: Upload coverage to Codecov
      if: inputs.upload-coverage && matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      uses: codecov/codecov-action@v5
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      with:
        files: ./coverage.xml
        fail_ci_if_error: false

    - name: Update README statistics
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        echo "Updating README statistics..."
        uv run python scripts/update_readme_stats.py || echo "README stats update completed with warnings"
      shell: bash
