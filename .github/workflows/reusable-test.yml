# Reusable Test Workflow
# Comprehensive test suite with advanced coverage reporting

name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for coverage upload'
        required: false
        default: '3.11'
        type: string
      upload-coverage:
        description: 'Whether to upload coverage to Codecov'
        required: false
        default: true
        type: boolean
    secrets:
      CODECOV_TOKEN:
        required: true

jobs:
  test-matrix:
    name: Test Suite (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          - os: windows-latest
            python-version: "3.10"
          - os: windows-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.10"
          - os: macos-latest
            python-version: "3.12"

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Analyzer
      uses: ./.github/actions/setup-analyzer
      with:
        os: ${{ matrix.os }}
        python-version: ${{ matrix.python-version }}
        uv-sync: "true"

    - name: Run Tests with Coverage
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        echo "### ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        # Exclude benchmarks and regression tests from the main CI run to speed it up
        uv run pytest tests/ -n auto -v --tb=short --maxfail=10 \
          -m "not benchmark and not regression" \
          --cov=tree_sitter_analyzer --cov-report=xml --cov-report=html --cov-report=term-missing \
          2>&1 | tee pytest-output.txt || touch test_failed

        # Detailed Coverage Reporting (Merged from test-coverage.yml)
        echo '```text' >> $GITHUB_STEP_SUMMARY
        tail -n 50 pytest-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        echo "### ðŸ“ˆ Coverage Details" >> $GITHUB_STEP_SUMMARY
        uv run python scripts/monitor_coverage.py summary >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Summary completed"

        echo "#### Low Coverage Files (< 50%)" >> $GITHUB_STEP_SUMMARY
        echo '```text' >> $GITHUB_STEP_SUMMARY
        uv run python scripts/monitor_coverage.py low --threshold 50 >> $GITHUB_STEP_SUMMARY 2>&1 || echo "None found"
        echo '```' >> $GITHUB_STEP_SUMMARY

        if [ -f test_failed ]; then
          echo "âŒ Tests failed!" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
      shell: bash

    - name: Run Tests (no coverage)
      if: matrix.os != 'ubuntu-latest' || matrix.python-version != inputs.python-version
      run: |
        # Exclude benchmarks and regression tests
        uv run pytest tests/ -n auto -v --tb=short --maxfail=10 \
          -m "not benchmark and not regression"
      shell: bash

    - name: Upload coverage to Codecov
      if: inputs.upload-coverage && matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
        flags: unittests
        name: codecov-umbrella

    - name: Upload Coverage HTML Report
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html-report
        path: htmlcov/
        retention-days: 7

    - name: Comment Coverage on PR
      if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ github.token }}
        MINIMUM_GREEN: 40
        MINIMUM_ORANGE: 30

    - name: Update README statistics
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == inputs.python-version
      run: |
        uv run python scripts/update_readme_stats.py || echo "README stats update completed with warnings"
      shell: bash
